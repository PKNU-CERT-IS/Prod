# API 서버 설정
{$DOMAIN} {
    # CORS preflight 요청은 Spring Boot에서 처리
    # Caddy에서는 단순히 백엔드로 전달

    # CORS 헤더는 Spring Boot에서 처리하므로 Caddy에서는 제거
    # Spring Boot의 CorsConfig에서 모든 CORS 정책을 관리

    # 보안 헤더 설정
    header {
        # 보안 헤더
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        Content-Security-Policy "default-src 'self'; connect-src 'self' https://www.cert-is.com https://cert-is.com"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }

    # 기타 요청 처리
    handle /* {
        reverse_proxy backend:8080 {
            header_up Host {http.request.host}
            header_up X-Real-IP {http.request.remote}
        }
    }

    # 액추에이터 엔드포인트
    handle /actuator/* {
        reverse_proxy backend:8080
    }

    # 기본 요청
    handle {
        respond "API Server is running" 200
    }

    # TLS 설정
    tls admin@cert-is.com

    # 간단한 로그 설정 - 기본 포맷 사용
    log {
        output file /logs/api_access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        # 포맷 설정 제거 - 기본값 사용
    }
}

# HTTP → HTTPS 리다이렉트
http://{$DOMAIN} {
    redir https://{$DOMAIN}{uri} permanent
}